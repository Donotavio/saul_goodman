name: Bump version on main

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_type:
        description: "Semver bump (major | minor | patch)"
        required: false
        default: "patch"
      create_tag:
        description: "Criar tag v<versão> após o bump (aciona release.yml)"
        required: false
        default: "true"

permissions:
  contents: write

jobs:
  bump-version:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Determine bump type
        id: bump_type
        run: |
          if [ -n "${{ github.event.inputs.release_type }}" ]; then
            TYPE="${{ github.event.inputs.release_type }}"
          else
            LAST_MSG="$(git log -1 --pretty=%B)"
            HEADER="$(printf '%s\n' "$LAST_MSG" | head -n1)"

            if printf '%s\n' "$LAST_MSG" | grep -qi "BREAKING CHANGE:"; then
              TYPE="major"
            elif printf '%s\n' "$HEADER" | grep -Eq '^([a-z0-9]+)(\([^)]+\))?!:'; then
              TYPE="major"
            elif printf '%s\n' "$HEADER" | grep -Eq '^feat(\([^)]+\))?:'; then
              TYPE="minor"
            else
              TYPE="patch"
            fi
          fi
          echo "type=$TYPE" >> "$GITHUB_OUTPUT"

      - name: Bump package version (no tag)
        id: bump
        run: |
          npm version "${{ steps.bump_type.outputs.type }}" --no-git-tag-version
          VERSION=$(node -pe "require('./package.json').version")
          node - <<'EOF'
          const fs = require('fs');
          const rootPkg = require('./package.json');
          const version = rootPkg.version;

          const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
          manifest.version = version;
          fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2) + '\n');

          const updatePkg = (file) => {
            if (!fs.existsSync(file)) return;
            const pkg = JSON.parse(fs.readFileSync(file, 'utf8'));
            pkg.version = version;
            fs.writeFileSync(file, JSON.stringify(pkg, null, 2) + '\n');
          };

          updatePkg('./saul-daemon/package.json');
          updatePkg('./vscode-extension/package.json');
          EOF
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Commit and push bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json manifest.json saul-daemon/package.json vscode-extension/package.json
          git commit -m "chore: bump version to v${{ steps.bump.outputs.version }}" || exit 0
          git push

      - name: Create and push tag (optional)
        if: github.event_name == 'push' || github.event.inputs.create_tag == 'true'
        run: |
          git tag "v${{ steps.bump.outputs.version }}"
          git push origin "v${{ steps.bump.outputs.version }}"
